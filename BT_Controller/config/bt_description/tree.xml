<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4">
  <BehaviorTree ID="Filling">
    <Occupy Uuid="{ProductID}"
            Asset="{Asset}"
            _skipIf="scrap == true">
      <ReactiveSequence>
        <ReactiveFallback>
          <Data_Condition comparison_type="equal"
                          Field="State"
                          expected_value="operational"
                          Property="PackMLState"
                          Asset="{Asset}"/>
          <Sleep msec="10000"/>
        </ReactiveFallback>
        <Sequence>
          <MoveToPosition Uuid="{ProductID}"
                          TargetPosition="{Asset}"
                          Asset="{Xbot}"/>
          <Command_Execution Parameters="&apos;{}&apos;"
                             Uuid="{ProductID}"
                             Operation="tare"
                             Asset="{Asset}"/>
          <BC_Fallback _onFailure="scrap:= true">
            <Data_Condition comparison_type="inside"
                            Field="Weight"
                            expected_value="2.0;2.2"
                            Property="weight"
                            Asset="{Asset}"/>
            <Sequence>
              <Data_Condition comparison_type="equal"
                              Field="Weight"
                              expected_value="0"
                              Property="weight"
                              Asset="{Asset}"/>
              <Command_Execution Parameters="&apos;{}&apos;"
                                 Uuid="{ProductID}"
                                 Operation="dispense"
                                 Asset="{Asset}"/>
            </Sequence>
            <Sequence>
              <Data_Condition comparison_type="greater"
                              Field="Weight"
                              expected_value="0"
                              Property="weight"
                              Asset="{Asset}"/>
              <Refill_Node Uuid="{ProductID}"
                           Asset="{Asset}"/>
            </Sequence>
          </BC_Fallback>
        </Sequence>
      </ReactiveSequence>
    </Occupy>
  </BehaviorTree>

  <BehaviorTree ID="Load">
    <SequenceWithMemory>
      <PopElement ProductID="{ProductID}"
                  if_empty="SUCCESS"
                  Queue="{ProductIDs}"
                  _onSuccess="scrap:= false"
                  _onFailure="scrap:= true"/>
      <Occupy Uuid="{ProductID}"
              Asset="{Asset}"
              _skipIf="scrap == true">
        <ReactiveSequence>
          <ReactiveFallback>
            <Data_Condition comparison_type="equal"
                            Field="State"
                            expected_value="operational"
                            Property="PackMLState"
                            Asset="{Asset}"/>
            <Sleep msec="10000"/>
          </ReactiveFallback>
          <Sequence>
            <MoveToPosition Uuid="{ProductID}"
                            TargetPosition="{Asset}"
                            Asset="{Xbot}"/>
            <Command_Execution Parameters="&apos;{}&apos;"
                               Uuid="{ProductID}"
                               Operation="load"
                               Asset="{Asset}"/>
          </Sequence>
        </ReactiveSequence>
      </Occupy>
    </SequenceWithMemory>
  </BehaviorTree>

  <BehaviorTree ID="MainTree">
    <Sequence>
      <Configure ProductIDs="{ProductIDs}"/>
      <ReactiveSequence>
        <Fallback>
          <Data_Condition comparison_type="equal"
                          Field="State"
                          expected_value="operational"
                          Property="PackMLState"
                          Asset="PlanarSystem"/>
          <SubTree ID="Planar SOP"
                   Asset="PlanarSystem"
                   _autoremap="true"/>
        </Fallback>
        <Parallel failure_count="-1"
                  success_count="1">
          <SubTree ID="Xbot_Production"
                   Xbot="Xbot1"
                   ProductID=""
                   _autoremap="true"/>
          <SubTree ID="Xbot_Production"
                   Xbot="Xbot2"
                   ProductID=""
                   _autoremap="true"/>
          <SubTree ID="Xbot_Production"
                   Xbot="Xbot3"
                   ProductID=""
                   _autoremap="true"/>
        </Parallel>
      </ReactiveSequence>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="Planar SOP">
    <Sequence>
      <Command_Execution Parameters="&apos;{ &quot;SopId&quot;: 10 }&apos;"
                         Uuid="{Uuid}"
                         Operation="operation"
                         Asset="{Asset}"/>
      <Command_Execution Parameters="&apos;{ &quot;SopId&quot;: 11 }&apos;"
                         Uuid="{Uuid}"
                         Operation="operation"
                         Asset="{Asset}"/>
      <Command_Execution Parameters="&apos;{ &quot;SopId&quot;: 12 }&apos;"
                         Uuid="{Uuid}"
                         Operation="operation"
                         Asset="{Asset}"/>
      <Command_Execution Parameters="&apos;{ &quot;SopId&quot;: 13 }&apos;"
                         Uuid="{Uuid}"
                         Operation="operation"
                         Asset="{Asset}"/>
      <Command_Execution Parameters="&apos;{ &quot;SopId&quot;: 0 }&apos;"
                         Uuid="{Uuid}"
                         Operation="operation"
                         Asset="{Asset}"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="QualityControl">
    <Occupy Uuid="{ProductID}"
            Asset="{Asset}"
            _skipIf="scrap == true">
      <ReactiveSequence>
        <ReactiveFallback>
          <Data_Condition comparison_type="equal"
                          Field="State"
                          expected_value="operational"
                          Property="PackMLState"
                          Asset="{Asset}"/>
          <Sleep msec="10000"/>
        </ReactiveFallback>
        <Sequence>
          <MoveToPosition Uuid="{ProductID}"
                          TargetPosition="{Asset}"
                          Asset="{Xbot}"/>
          <Command_Execution Parameters="&apos;{}&apos;"
                             Uuid="{ProductID}"
                             Operation="capture"
                             Asset="{Asset}"/>
        </Sequence>
      </ReactiveSequence>
    </Occupy>
  </BehaviorTree>

  <BehaviorTree ID="Scrap">
    <Occupy Uuid="{ProductID}"
            Asset="{Asset}">
      <ReactiveSequence>
        <ReactiveFallback>
          <Data_Condition comparison_type="equal"
                          Field="State"
                          expected_value="operational"
                          Property="PackMLState"
                          Asset="{Asset}"/>
          <Sleep msec="10000"/>
        </ReactiveFallback>
        <Sequence>
          <MoveToPosition Uuid="{ProductID}"
                          TargetPosition="{Asset}"
                          Asset="{Xbot}"/>
          <Command_Execution Parameters="&apos;{}&apos;"
                             Uuid="{ProductID}"
                             Operation="unload"
                             Asset="{Asset}"
                             _onSuccess="scrap:=false"/>
        </Sequence>
      </ReactiveSequence>
    </Occupy>
  </BehaviorTree>

  <BehaviorTree ID="Stoppering">
    <Occupy Uuid="{ProductID}"
            Asset="{Asset}"
            _skipIf="scrap == true">
      <ReactiveSequence>
        <ReactiveFallback>
          <Data_Condition comparison_type="equal"
                          Field="State"
                          expected_value="operational"
                          Property="PackMLState"
                          Asset="{Asset}"/>
          <Sleep msec="10000"/>
        </ReactiveFallback>
        <Sequence>
          <MoveToPosition Uuid="{ProductID}"
                          TargetPosition="{Asset}"
                          Asset="{Xbot}"/>
          <Command_Execution Parameters="&apos;{}&apos;"
                             Uuid="{ProductID}"
                             Operation="stopper"
                             Asset="{Asset}"/>
        </Sequence>
      </ReactiveSequence>
    </Occupy>
  </BehaviorTree>

  <BehaviorTree ID="Unload">
    <Occupy Uuid="{ProductID}"
            Asset="{Asset}"
            _skipIf="scrap == true">
      <ReactiveSequence>
        <ReactiveFallback>
          <Data_Condition comparison_type="equal"
                          Field="State"
                          expected_value="operational"
                          Property="PackMLState"
                          Asset="{Asset}"/>
          <Sleep msec="10000"/>
        </ReactiveFallback>
        <Sequence>
          <MoveToPosition Uuid="{ProductID}"
                          TargetPosition="{Asset}"
                          Asset="{Xbot}"/>
          <Command_Execution Parameters="&apos;{}&apos;"
                             Uuid="{ProductID}"
                             Operation="unload"
                             Asset="{Asset}"/>
        </Sequence>
      </ReactiveSequence>
    </Occupy>
  </BehaviorTree>

  <BehaviorTree ID="Xbot_Production">
    <Occupy Uuid="{Uuid}"
            Asset="{Xbot}">
      <KeepRunningUntilEmpty if_empty="SUCCESS"
                             Queue="{ProductIDs}">
        <ReactiveSequence>
          <ReactiveFallback>
            <Data_Condition comparison_type="equal"
                            Field="State"
                            expected_value="operational"
                            Property="PackMLState"
                            Asset="{Xbot}"/>
            <Sleep msec="10000"/>
          </ReactiveFallback>
          <Fallback>
            <SequenceWithMemory>
              <SubTree ID="Load"
                       Asset="Load"
                       _autoremap="true"/>
              <SubTree ID="Filling"
                       Asset="Filling"
                       _autoremap="true"/>
              <SubTree ID="Stoppering"
                       Asset="Stoppering"
                       _autoremap="true"/>
              <SubTree ID="QualityControl"
                       Asset="Camera"
                       _autoremap="true"/>
              <SubTree ID="Unload"
                       Asset="Unload"
                       _autoremap="true"/>
            </SequenceWithMemory>
            <SubTree ID="Scrap"
                     Asset="Unload"
                     _autoremap="true"/>
          </Fallback>
        </ReactiveSequence>
      </KeepRunningUntilEmpty>
    </Occupy>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Control ID="BC_Fallback"/>
    <Action ID="Command_Execution">
      <input_port name="Parameters"
                  default="&apos;{}&apos;"
                  type="nlohmann::json_abi_v3_11_3::basic_json&lt;std::map, std::vector, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, bool, long, unsigned long, double, std::allocator, nlohmann::json_abi_v3_11_3::adl_serializer, std::vector&lt;unsigned char, std::allocator&lt;unsigned char&gt; &gt;, void&gt;">The parameters for the operation</input_port>
      <input_port name="Uuid"
                  default="{Uuid}"
                  type="std::string">UUID for the operation to execute</input_port>
      <input_port name="Operation"
                  default="Operation"
                  type="std::string">The operation to execute on the asset</input_port>
      <input_port name="Asset"
                  default="{Asset}"
                  type="std::string">The asset used for execution</input_port>
    </Action>
    <Action ID="Configure">
      <output_port name="ProductIDs"
                   default="{ProductIDs}"
                   type="std::shared_ptr&lt;std::deque&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::allocator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt; &gt; &gt;">List of product IDs to produce</output_port>
    </Action>
    <Condition ID="Data_Condition">
      <input_port name="comparison_type"
                  type="std::string">Type of comparison: equal, not_equal, greater, less, contains</input_port>
      <input_port name="Field"
                  type="std::string">Name of the field to monitor in the MQTT message</input_port>
      <input_port name="expected_value"
                  type="std::string">Value to compare against</input_port>
      <input_port name="Property"
                  type="std::string">The property interface from the Asset</input_port>
      <input_port name="Asset"
                  default="{Asset}"
                  type="std::string">The Asset from which to receive a message</input_port>
    </Condition>
    <SubTree ID="Filling"
             editable="true">
      <input_port name="Asset"
                  default="Filling"/>
    </SubTree>
    <Decorator ID="KeepRunningUntilEmpty">
      <input_port name="if_empty"
                  default="SUCCESS"
                  type="BT::NodeStatus">Status to return if queue is empty: SUCCESS, FAILURE, SKIPPED</input_port>
      <input_port name="Queue"
                  default="{ProductIDs}"
                  type="std::shared_ptr&lt;std::deque&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::allocator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt; &gt; &gt;">The queue to monitor. Node runs child while this queue is not empty.</input_port>
    </Decorator>
    <SubTree ID="Load"
             editable="true">
      <input_port name="Asset"
                  default="Load"/>
    </SubTree>
    <Action ID="MoveToPosition">
      <input_port name="Uuid"
                  default="{ProductID}"
                  type="std::string">UUID for the command to execute</input_port>
      <input_port name="TargetPosition"
                  default="{Asset}"
                  type="std::string">The name of the asset to move to</input_port>
      <input_port name="Asset"
                  default="{Asset}"
                  type="std::string">The Asset to execute the movement</input_port>
    </Action>
    <Decorator ID="Occupy">
      <inout_port name="Uuid"
                  default="{Uuid}"
                  type="std::string">UUID Used for registration</inout_port>
      <input_port name="Asset"
                  default="{Asset}"
                  type="std::string">The Asset to register with</input_port>
    </Decorator>
    <Action ID="PopElement">
      <output_port name="ProductID"
                   default="{ProductID}"
                   type="std::string">The product ID popped from the queue.</output_port>
      <input_port name="if_empty"
                  default="SUCCESS"
                  type="BT::NodeStatus">Status to return if the queue is empty (SUCCESS, FAILURE, SKIPPED).</input_port>
      <input_port name="Queue"
                  default="{ProductIDs}"
                  type="std::shared_ptr&lt;std::deque&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt;, std::allocator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char&gt;, std::allocator&lt;char&gt; &gt; &gt; &gt; &gt;">The shared queue of product IDs. An element will be popped from it.</input_port>
    </Action>
    <SubTree ID="QualityControl"
             editable="true">
      <input_port name="Asset"
                  default="Camera"/>
    </SubTree>
    <Action ID="Refill_Node">
      <input_port name="Uuid"
                  default="{ID}"
                  type="std::string">UUID for the command to execute</input_port>
      <input_port name="Asset"
                  default="{Asset}"
                  type="std::string">The asset used for refilling</input_port>
    </Action>
    <SubTree ID="Scrap"
             editable="true">
      <input_port name="Asset"
                  default="Scrap"/>
    </SubTree>
    <SubTree ID="Stoppering"
             editable="true">
      <input_port name="Asset"
                  default="Stoppering"/>
    </SubTree>
    <SubTree ID="Unload"
             editable="true">
      <input_port name="Asset"
                  default="Unload"/>
    </SubTree>
    <SubTree ID="Xbot_Production"
             editable="true">
      <input_port name="Xbot"
                  default="Xbot1"/>
      <output_port name="ProductID"/>
    </SubTree>
  </TreeNodesModel>

</root>
