services:
  
  # hivemq-broker:
  #   image: hivemq/hivemq4:latest
  #   container_name: hivemq-broker
  #   volumes:
  #     - ./HiveMQ/conf:/opt/hivemq/conf
  #     - ./HiveMQ/extensions:/opt/hivemq/extensions
  #   restart: unless-stopped
  #   ports:
  #     - "1883:1883"
  #     - "8080:8080"
  #     - "8883:8883"
  #     - "8884:8884"
  #     - "8091:8081"
  #     - "8000:8000"
  #   networks:
  #     - hivemq-network

  hivemq-broker:
    image: eclipse-mosquitto
    container_name: hivemq-broker
    volumes:
      - ./Mosquitto/config:/mosquitto/config:rw
      - ./Mosquitto/data:/mosquitto/data:rw
      - ./Mosquitto/log:/mosquitto/log:rw
    restart: unless-stopped
    ports:
      - "1883:1883" #default mqtt port
      - "9001:9001" #default mqtt port for websockets
    networks:
      - hivemq-network

  frontend:
    build:
      context: ./Configurator
      dockerfile: Dockerfile.frontend
      target: dev
    ports:
      - "5173:5173"
    volumes:
      - ./Configurator:/app
      - /app/node_modules
    environment:
      - NODE_ENV=development
      - VITE_MQTT_BROKER_HOST=${EXTERNAL_HOST:-localhost}
      - VITE_MQTT_BROKER_PORT=${MQTT_WS_PORT:-9001}
      - VITE_AAS_REPOSITORY_URL=http://${EXTERNAL_HOST:-localhost}:8081
      - VITE_AAS_SHELL_REGISTRY_URL=http://${EXTERNAL_HOST:-localhost}:8082
    networks:
      - hivemq-network
    depends_on:
      - hivemq-broker
    restart: unless-stopped
    
  timescaledb:
    image: timescale/timescaledb:latest-pg14
    container_name: timescaledb
    volumes:
      # - ./TimescaleDB/timescaledb-data:/var/lib/postgresql/data
      - ./TimescaleDB/database/init-scripts:/docker-entrypoint-initdb.d
    environment:
      - POSTGRES_PASSWORD=admin
      - POSTGRES_USER=admin
      - POSTGRES_DB=uns_data
    ports:
      - "5432:5432"
    networks:
      - hivemq-network
    restart: unless-stopped
  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: grafana
  #   user: "472"
  #   volumes:
  #     - ./Grafana/grafana-data:/var/lib/grafana
  #   environment:
  #     - GF_SECURITY_ADMIN_PASSWORD=admin
  #     - GF_USERS_ALLOW_SIGN_UP=false
  #     - GF_PLUGINS_PREINSTALL=grafana-clock-panel,grafana-simple-json-datasource, volkovlabs-image-panel
  #   ports:
  #     - "3000:3000"
  #   networks:
  #     - hivemq-network
  #   depends_on:
  #     - timescaledb
  #   restart: unless-stopped
 
  groot:
    build:
      context: ./Groot2
      dockerfile: groot2.dockerfile
    container_name: groot2-web
    volumes:
      - ./BT_Controller/config/bt_description:/bt_description
      - ./offlineResponse_1656FB-A61627-4A4CB2-F0C0CA-8531ED-BD332C.dat:/bt_description/offlineResponse_1656FB-A61627-4A4CB2-F0C0CA-8531ED-BD332C.dat
    ports:
      - "6080:6080"
    networks:
      - hivemq-network
    restart: unless-stopped

  mqtt-explorer:
    image: smeagolworms4/mqtt-explorer
    container_name: mqtt-explorer
    volumes:
      - ./MQTT-Explorer/config:/mqtt-explorer/config
    ports:
      - "4000:4000"
    environment:
      - HTTP_PORT=4000
      - CONFIG_PATH=/mqtt-explorer/config
    networks:
      - hivemq-network
    depends_on:
      - hivemq-broker
    restart: unless-stopped
    
  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./Portainer/data:/data
    ports:
      - "9000:9000"
    networks:
      - hivemq-network
    restart: unless-stopped

  bt_controller:
    build:
      context: .
      dockerfile: BT_Controller/dockerfile
    container_name: bt_controller
    environment:
      - MQTT_BROKER=${MQTT_BROKER:-hivemq-broker}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - AAS_SERVER=${AAS_SERVER:-aas-env}
      - AAS_PORT=${AAS_PORT:-8081}
      - AAS_REGISTRY=${AAS_REGISTRY:-aas-registry}
      - AAS_REGISTRY_PORT=${AAS_REGISTRY_PORT:-8080}
    volumes:
      - ./BT_Controller/config:/AP2030-UNS/BT_Controller/config
      - ./BTDescriptions:/AP2030-UNS/MQTTSchemas
      - ./AASDescriptions:/AP2030-UNS/AASDescriptions
    ports:
    - "1667:1667"
    networks:
      - hivemq-network
    depends_on:
      hivemq-broker:
        condition: service_started
      registration-service:
        condition: service_healthy

  planar_controller:
    build:
      context: ./Planar_Controller
      dockerfile: Dockerfile
    container_name: planar_controller
    environment:
      - MQTT_BROKER=${MQTT_BROKER:-hivemq-broker}
      - MQTT_PORT=${MQTT_PORT:-1883}
      - PMC_IP=${PMC_IP:-192.168.0.199}
    volumes:
      - ./MQTTSchemas:/app/MQTTSchemas
      - ./AASDescriptions:/app/AASDescriptions
    networks:
      - hivemq-network
    depends_on:
      hivemq-broker:
        condition: service_started
      aas-env:
        condition: service_started
      databridge:
        condition: service_started
      registration-service:
        condition: service_healthy
    restart: unless-stopped

  production_planner:
    extends:
      file: ./PackML_Stations/stations-compose.yml
      service: production_planner
    networks:
      - hivemq-network
    depends_on:
      hivemq-broker:
        condition: service_started
      aas-env:
        condition: service_started
      databridge:
        condition: service_started
      registration-service:
        condition: service_healthy

  filling_station:
    extends:
      file: ./PackML_Stations/stations-compose.yml
      service: filling_station
    networks:
      - hivemq-network
    depends_on:
      hivemq-broker:
        condition: service_started
      aas-env:
        condition: service_started
      databridge:
        condition: service_started
      registration-service:
        condition: service_healthy

  # camera_station:
  #   extends:
  #     file: ./PackML_Stations/stations-compose.yml
  #     service: camera_station
  #   networks:
  #     - hivemq-network
  #   depends_on:
  #     - hivemq-broker
      
  stoppering_station:
    extends:
      file: ./PackML_Stations/stations-compose.yml
      service: stoppering_station
    networks:
      - hivemq-network
    depends_on:
      hivemq-broker:
        condition: service_started
      aas-env:
        condition: service_started
      databridge:
        condition: service_started
      registration-service:
        condition: service_healthy

  load_station:
    extends:
      file: ./PackML_Stations/stations-compose.yml
      service: load_station
    networks:
      - hivemq-network
    depends_on:
      hivemq-broker:
        condition: service_started
      aas-env:
        condition: service_started
      databridge:
        condition: service_started
      registration-service:
        condition: service_healthy

  unload_station:
    extends:
      file: ./PackML_Stations/stations-compose.yml
      service: unload_station
    networks:
      - hivemq-network
    depends_on:
      hivemq-broker:
        condition: service_started
      aas-env:
        condition: service_started
      databridge:
        condition: service_started
      registration-service:
        condition: service_healthy



################################### BASYX CONTAINERS ####################################

  aas-env:
    image: eclipsebasyx/aas-environment:2.0.0-SNAPSHOT
    container_name: aas-env
    environment:
      - SERVER_PORT=8081
      - EXTERNAL_HOST=${EXTERNAL_HOST:-localhost}
      - BASYX_BACKEND=MongoDB
      - BASYX_ENVIRONMENT=file:aas
      - BASYX_CORS_ALLOWED_ORIGINS=*
      - BASYX_CORS_ALLOWED_METHODS=GET,POST,PATCH,DELETE,PUT,OPTIONS,HEAD
      - BASYX_AASREPOSITORY_FEATURE_REGISTRYINTEGRATION=http://aas-registry:8080
      - BASYX_SUBMODELREPOSITORY_FEATURE_REGISTRYINTEGRATION=http://sm-registry:8080
      - BASYX_EXTERNALURL=http://${EXTERNAL_HOST:-localhost}:8081
      - SPRING_SERVLET_MULTIPART_MAX_FILE_SIZE=500MB
      - SPRING_SERVLET_MULTIPART_MAX_REQUEST_SIZE=500MB
      - SPRING_DATA_MONGODB_HOST=mongo
      - SPRING_DATA_MONGODB_DATABASE=aas-env
      - SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE=admin
      - SPRING_DATA_MONGODB_USERNAME=mongoAdmin
      - SPRING_DATA_MONGODB_PASSWORD=mongoPassword
      - MQTT_HOSTNAME=hivemq-broker
      - MQTT_PORT=1883
      - MQTT_CLIENTID=aas-env-client
      - BASYX_AASREPOSITORY_FEATURE_MQTT_ENABLED=false
      - BASYX_SUBMODELREPOSITORY_FEATURE_MQTT_ENABLED=false
    volumes:
      - ./aas:/application/aas
    ports:
      - '8081:8081'
    restart: always
    depends_on:
      aas-registry:
        condition: service_healthy
      sm-registry:
        condition: service_healthy
      mongo:
        condition: service_healthy
      hivemq-broker:
        condition: service_started
    networks:
      - hivemq-network
  aas-registry:
    image: eclipsebasyx/aas-registry-log-mongodb:2.0.0-SNAPSHOT
    container_name: aas-registry
    ports:
      - '8082:8080'
    environment:
      - SERVER_PORT=8080
      - SPRING_DATA_MONGODB_HOST=mongo
      - SPRING_DATA_MONGODB_PORT=27017
      - SPRING_DATA_MONGODB_DATABASE=aas-registry
      - SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE=admin
      - SPRING_DATA_MONGODB_USERNAME=mongoAdmin
      - SPRING_DATA_MONGODB_PASSWORD=mongoPassword
      - BASYX_CORS_ALLOWED_ORIGINS=*
      - BASYX_CORS_ALLOWED_METHODS=GET,POST,PATCH,DELETE,PUT,OPTIONS,HEAD
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - hivemq-network
  sm-registry:
    image: eclipsebasyx/submodel-registry-log-mongodb:2.0.0-SNAPSHOT
    container_name: sm-registry
    ports:
      - '8083:8080'
    environment:
      - SERVER_PORT=8080
      - SPRING_DATA_MONGODB_HOST=mongo
      - SPRING_DATA_MONGODB_PORT=27017
      - SPRING_DATA_MONGODB_DATABASE=sm-registry
      - SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE=admin
      - SPRING_DATA_MONGODB_USERNAME=mongoAdmin
      - SPRING_DATA_MONGODB_PASSWORD=mongoPassword
      - BASYX_CORS_ALLOWED_ORIGINS=*
      - BASYX_CORS_ALLOWED_METHODS=GET,POST,PATCH,DELETE,PUT,OPTIONS,HEAD
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - hivemq-network
  aas-discovery:
    image: eclipsebasyx/aas-discovery:2.0.0-SNAPSHOT
    container_name: aas-discovery
    environment:
      - SERVER_PORT=8081
      - SPRING_APPLICATION_NAME=AAS Discovery Service
      - BASYX_AASDISCOVERYSERVICE_NAME=aas-discovery-service
      - BASYX_BACKEND=MongoDB
      - BASYX_CORS_ALLOWED_ORIGINS=*
      - BASYX_CORS_ALLOWED_METHODS=GET,POST,PATCH,DELETE,PUT,OPTIONS,HEAD
      - SPRING_DATA_MONGODB_HOST=mongo
      - SPRING_DATA_MONGODB_DATABASE=aas-discovery
      - SPRING_DATA_MONGODB_AUTHENTICATION_DATABASE=admin
      - SPRING_DATA_MONGODB_USERNAME=mongoAdmin
      - SPRING_DATA_MONGODB_PASSWORD=mongoPassword
    ports:
      - '8084:8081'
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - hivemq-network
  mongo:
    image: mongo:5.0.10
    container_name: mongo
    environment:
      MONGO_INITDB_ROOT_USERNAME: mongoAdmin
      MONGO_INITDB_ROOT_PASSWORD: mongoPassword
    restart: always
    healthcheck:
      test: mongo
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - hivemq-network
  aas-web-ui:
    image: eclipsebasyx/aas-gui:SNAPSHOT
    container_name: aas-ui
    ports:
      - '3001:3000'
    environment:
      AAS_REGISTRY_PATH: http://${EXTERNAL_HOST:-localhost}:8082/shell-descriptors
      SUBMODEL_REGISTRY_PATH: http://${EXTERNAL_HOST:-localhost}:8083/submodel-descriptors
      AAS_REPO_PATH: http://${EXTERNAL_HOST:-localhost}:8081/shells
      SUBMODEL_REPO_PATH: http://${EXTERNAL_HOST:-localhost}:8081/submodels
      CD_REPO_PATH: http://${EXTERNAL_HOST:-localhost}:8081/concept-descriptions
      AAS_DISCOVERY_PATH: http://${EXTERNAL_HOST:-localhost}:8084/lookup/shells
      PRIMARY_COLOR: '#0036AA'
      DASHBOARD_SERVICE_PATH: http://${EXTERNAL_HOST:-localhost}:8085/api/elements
    restart: always
    depends_on:
      aas-env:
        condition: service_started
    networks:
      - hivemq-network 
  dashboard-api:
    image: aaronzi/basyx-dashboard-api:SNAPSHOT_02
    container_name: dashboard-api
    environment:
      - EXTERNAL_HOST=${EXTERNAL_HOST:-localhost}
    ports:
      - '8085:8085'
    volumes:
      - ./basyx/aas-dashboard.yml:/application.yml
    restart: always
    depends_on:
      mongo:
        condition: service_healthy
    networks:
      - hivemq-network
  databridge:
    image: eclipsebasyx/databridge:1.0.0-milestone-08
    container_name: databridge
    volumes:
      - ./databridge:/usr/share/config
    restart: always
    depends_on:
      aas-env:
        condition: service_healthy
      hivemq-broker:
        condition: service_started
    networks:
      - hivemq-network
  
  registration-service:
    build:
      context: .
      dockerfile: ./Registration_Service/Dockerfile
    container_name: registration-service
    environment:
      - PYTHONUNBUFFERED=1
      - BASYX_URL=http://${AAS_SERVER:-aas-env}:${AAS_PORT:-8081}
      - MQTT_BROKER=${MQTT_BROKER:-hivemq-broker}
      - MQTT_PORT=${MQTT_PORT:-1883}
      # Delegation URL for BaSyx to call - must be reachable from aas-env container
      - DELEGATION_SERVICE_URL=http://registration-service:8087
      - EXTERNAL_HOST=${EXTERNAL_HOST:-localhost}
      - AAS_SERVER_URL=http://${AAS_SERVER:-aas-env}:${AAS_PORT:-8081}
      - AAS_BASE_URL=https://smartproductionlab.aau.dk
    volumes:
      # DataBridge config directory for writing configs
      - ./databridge:/databridge
      # AAS configs for registration
      - ./AASDescriptions/Resource/configs:/app/configs:ro
      # MQTT Schemas for schema-based message generation
      - ./MQTTSchemas:/app/MQTTSchemas:ro
      # Docker socket for container restarts (DataBridge)
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      # Operation Delegation HTTP API port
      - '8087:8087'
    command:
      - python
      - unified-registration-service.py
      - --mqtt-broker
      - ${MQTT_BROKER:-hivemq-broker}
      - --mqtt-port
      - "${MQTT_PORT:-1883}"
      - --basyx-url
      - http://${AAS_SERVER:-aas-env}:${AAS_PORT:-8081}
      - --delegation-url
      - ${DELEGATION_SERVICE_URL:-http://localhost:8087}
      - listen
      - --delegation-port
      - "8087"
    restart: unless-stopped
    depends_on:
      hivemq-broker:
        condition: service_started
      aas-env:
        condition: service_started
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8087/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 12
      start_period: 10s
    networks:
      - hivemq-network


#################Â¤ NETWORKS AND VOLUMES ####################
networks:
  hivemq-network:
    driver: bridge